{% extends "decision_system/base.html" %}

{% block title %}Healthcare Dashboard - Surplus Med{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Healthcare Review Dashboard</h1>
    <p class="page-subtitle">Review and make decisions on medical supply submissions</p>
</div>

<!-- Statistics Overview -->
<div class="grid grid-4 mb-4">
    <div class="stat-card">
        <div class="stat-value">{{ stats.pending_review }}</div>
        <div class="stat-label">Pending Review</div>
    </div>
    <div class="stat-card success">
        <div class="stat-value">{{ stats.accepted }}</div>
        <div class="stat-label">Accepted</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-value">{{ stats.needs_review }}</div>
        <div class="stat-label">Needs Review</div>
    </div>
    <div class="stat-card danger">
        <div class="stat-value">{{ stats.rejected }}</div>
        <div class="stat-label">Rejected</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mb-4">
    <div class="card-header">
        <h2 class="card-title">Quick Actions</h2>
    </div>
    <div class="card-body">
        <div class="flex gap-2">
            <a href="{% url 'decision_system:supply_submit' %}" class="btn btn-primary">
                Submit New Supply
            </a>
            <a href="{% url 'decision_system:export_audit' %}" class="btn btn-outline">
                Export Audit Report
            </a>
            {% if user.is_staff %}
            <a href="{% url 'decision_system:manage_rules' %}" class="btn btn-secondary">
                Manage Eligibility Rules
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Pending Reviews -->
<div class="card">
    <div class="card-header flex flex-between">
        <h2 class="card-title">Pending Decisions</h2>
        <div class="flex gap-2">
            <select id="filter-status" class="form-control" style="width: 200px;">
                <option value="all">All Statuses</option>
                <option value="PENDING_INITIAL">Pending Initial Review</option>
                <option value="PENDING_FINAL">Pending Final Approval</option>
                <option value="NEEDS_REVIEW">Needs Additional Review</option>
            </select>
            <input type="text" id="search-supply" class="form-control" placeholder="Search supplies..." style="width: 250px;">
        </div>
    </div>
    <div class="card-body">
        {% if pending_supplies %}
        <table class="table">
            <thead>
                <tr>
                    <th>Supply ID</th>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Quantity</th>
                    <th>Submitted</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for supply in pending_supplies %}
                <tr>
                    <td><strong>{{ supply.supply_id }}</strong></td>
                    <td>{{ supply.item_name }}</td>
                    <td>{{ supply.category }}</td>
                    <td>{{ supply.quantity }} {{ supply.unit }}</td>
                    <td>{{ supply.submitted_date|date:"M d, Y" }}</td>
                    <td>
                        {% if supply.decision_status == 'PENDING_INITIAL' %}
                            <span class="badge badge-pending">Pending Initial</span>
                        {% elif supply.decision_status == 'PENDING_FINAL' %}
                            <span class="badge badge-review">Pending Final</span>
                        {% elif supply.decision_status == 'NEEDS_REVIEW' %}
                            <span class="badge badge-review">Needs Review</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if supply.days_until_expiry < 90 %}
                            <span class="text-danger">High</span>
                        {% elif supply.days_until_expiry < 180 %}
                            <span class="text-warning">Medium</span>
                        {% else %}
                            <span class="text-success">Normal</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'decision_system:supply_review' supply.id %}" class="btn btn-primary btn-sm">
                            Review
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
            <strong>No pending reviews.</strong> All submissions have been processed.
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Decisions -->
<div class="card mt-4">
    <div class="card-header">
        <h2 class="card-title">Recent Decisions</h2>
    </div>
    <div class="card-body">
        {% if recent_decisions %}
        <table class="table">
            <thead>
                <tr>
                    <th>Supply ID</th>
                    <th>Item Name</th>
                    <th>Decision</th>
                    <th>Decided By</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for decision in recent_decisions %}
                <tr>
                    <td><strong>{{ decision.supply.supply_id }}</strong></td>
                    <td>{{ decision.supply.item_name }}</td>
                    <td>
                        {% if decision.decision == 'ACCEPTED' %}
                            <span class="badge badge-accepted">Accepted</span>
                        {% elif decision.decision == 'REVIEW' %}
                            <span class="badge badge-review">Review Required</span>
                        {% elif decision.decision == 'REJECTED' %}
                            <span class="badge badge-rejected">Rejected</span>
                        {% endif %}
                    </td>
                    <td>{{ decision.decided_by.username }}</td>
                    <td>{{ decision.decision_date|date:"M d, Y H:i" }}</td>
                    <td>
                        <a href="{% url 'decision_system:decision_detail' decision.id %}" class="btn btn-secondary btn-sm">
                            View Details
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">No recent decisions.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Simple client-side filtering
    document.getElementById('search-supply').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('.table tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    document.getElementById('filter-status').addEventListener('change', function(e) {
        const filterValue = e.target.value;
        const rows = document.querySelectorAll('.table tbody tr');

        rows.forEach(row => {
            if (filterValue === 'all') {
                row.style.display = '';
            } else {
                const statusBadge = row.querySelector('.badge');
                const statusText = statusBadge ? statusBadge.textContent.trim() : '';
                const matches =
                    (filterValue === 'PENDING_INITIAL' && statusText === 'Pending Initial') ||
                    (filterValue === 'PENDING_FINAL' && statusText === 'Pending Final') ||
                    (filterValue === 'NEEDS_REVIEW' && statusText === 'Needs Review');
                row.style.display = matches ? '' : 'none';
            }
        });
    });
</script>
{% endblock %}
